<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badass Guitar Practice Tracker!</title>
    <style>
        /* Include your existing styles here */
        
        /* New styles for the time partitioning feature */
        .time-allocation-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .slider-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider-label span:last-child {
            font-weight: bold;
        }
        
        .time-slider {
            width: 100%;
            margin-top: 5px;
        }
        
        .time-allocation-summary {
            margin-top: 15px;
            padding: 10px;
            background-color: #e0e7ff;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .allocation-warning {
            color: #f44336;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Your existing HTML here... -->
    
    <!-- Modification to the log-tab section -->
    <div id="log-tab" class="tab-content active">
        <h2>Log Practice Session</h2>
        <div class="timer-container" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
            <h3>Practice Timer</h3>
            <div class="timer-display" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">00:00:00</div>
            <div class="timer-controls">
                <button id="start-timer" class="timer-btn" style="background-color: #4caf50;">Start</button>
                <button id="pause-timer" class="timer-btn" style="background-color: #ff9800;" disabled>Pause</button>
                <button id="stop-timer" class="timer-btn" style="background-color: #f44336;" disabled>Stop</button>
            </div>
        </div>
        <form id="practice-form">
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label for="duration">Duration (minutes)</label>
                <input type="number" id="duration" min="1" value="30" required>
            </div>
            <div class="form-group">
                <label>Techniques Practiced</label>
                <div id="technique-checkboxes"></div>
            </div>
            <div class="form-group">
                <label>Songs Practiced</label>
                <div id="song-checkboxes"></div>
            </div>
            
            <!-- New Time Allocation section -->
            <div class="time-allocation-container">
                <h3>Time Allocation</h3>
                <p>Drag the sliders to allocate your practice time between techniques and songs.</p>
                <p class="allocation-warning" id="allocation-warning">Total allocation doesn't match session duration!</p>
                <div id="allocation-sliders">
                    <!-- Sliders will be generated here by JavaScript -->
                </div>
                <div class="time-allocation-summary">
                    <div>Total Allocated: <span id="total-allocated">0</span> minutes</div>
                    <div>Remaining: <span id="remaining-time">30</span> minutes</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" rows="3"></textarea>
            </div>
            <button type="submit">Save Practice Session</button>
        </form>
    </div>
    
    <!-- Your existing HTML continues... -->
    
    <script>
        // Your existing JavaScript code here...
        
        // Add to your existing practiceData structure
        // Add timeAllocations to the session objects
        let practiceData = {
            sessions: [],
            techniques: [
                { id: 1, name: 'Scales', level: 0 },
                { id: 2, name: 'Chords', level: 0 },
                { id: 3, name: 'Fingerpicking', level: 0 }
            ],
            songs: [
                { id: 1, name: 'Example Song 1', progress: 0 },
                { id: 2, name: 'Example Song 2', progress: 0 }
            ],
            settings: {
                levelUpMinutes: 60,
                songCompletionMinutes: 120,
                streakThreshold: 1
            }
        };
        
        // New functions for time allocation feature
        
        // Function to update time allocation sliders based on selections
        function updateTimeAllocationSliders() {
            const container = document.getElementById('allocation-sliders');
            container.innerHTML = '';
            
            const duration = Number(document.getElementById('duration').value);
            let selectedItems = [];
            
            // Get selected techniques
            document.querySelectorAll('#technique-checkboxes input:checked').forEach(checkbox => {
                const techId = Number(checkbox.getAttribute('data-tech-id'));
                const tech = practiceData.techniques.find(t => t.id === techId);
                if (tech) {
                    selectedItems.push({
                        id: techId,
                        name: tech.name,
                        type: 'technique',
                        allocation: 0
                    });
                }
            });
            
            // Get selected songs
            document.querySelectorAll('#song-checkboxes input:checked').forEach(checkbox => {
                const songId = Number(checkbox.getAttribute('data-song-id'));
                const song = practiceData.songs.find(s => s.id === songId);
                if (song) {
                    selectedItems.push({
                        id: songId,
                        name: song.name,
                        type: 'song',
                        allocation: 0
                    });
                }
            });
            
            // If nothing selected, show message
            if (selectedItems.length === 0) {
                container.innerHTML = '<p>Select techniques and songs to allocate time.</p>';
                return;
            }
            
            // Distribute time evenly initially
            const evenAllocation = Math.floor(duration / selectedItems.length);
            let remaining = duration - (evenAllocation * selectedItems.length);
            
            selectedItems.forEach(item => {
                item.allocation = evenAllocation;
                if (remaining > 0) {
                    item.allocation++;
                    remaining--;
                }
            });
            
            // Create sliders for each item
            selectedItems.forEach((item, index) => {
                const sliderId = `slider-${item.type}-${item.id}`;
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'slider-container';
                sliderDiv.innerHTML = `
                    <div class="slider-label">
                        <span>${item.name}</span>
                        <span id="value-${sliderId}">${item.allocation} min</span>
                    </div>
                    <input type="range" id="${sliderId}" class="time-slider" 
                           min="0" max="${duration}" value="${item.allocation}" 
                           data-index="${index}">
                `;
                container.appendChild(sliderDiv);
                
                // Add event listener to the slider
                document.getElementById(sliderId).addEventListener('input', function() {
                    updateAllocationValues(selectedItems);
                });
            });
            
            // Store selected items for later use
            container.dataset.selectedItems = JSON.stringify(selectedItems);
            
            // Update summary
            updateAllocationSummary(selectedItems, duration);
        }
        
        // Function to update allocation values when sliders change
        function updateAllocationValues(selectedItems) {
            const sliders = document.querySelectorAll('.time-slider');
            const duration = Number(document.getElementById('duration').value);
            let total = 0;
            
            // Update each slider value display and collect total
            sliders.forEach(slider => {
                const index = Number(slider.getAttribute('data-index'));
                const value = Number(slider.value);
                selectedItems[index].allocation = value;
                
                document.getElementById(`value-${slider.id}`).textContent = `${value} min`;
                total += value;
            });
            
            // Update summary
            updateAllocationSummary(selectedItems, duration);
        }
        
        // Function to update allocation summary
        function updateAllocationSummary(selectedItems, duration) {
            const total = selectedItems.reduce((sum, item) => sum + item.allocation, 0);
            const remaining = duration - total;
            
            document.getElementById('total-allocated').textContent = total;
            document.getElementById('remaining-time').textContent = remaining;
            
            // Show warning if allocation doesn't match duration
            const warningElement = document.getElementById('allocation-warning');
            if (remaining !== 0) {
                warningElement.style.display = 'block';
            } else {
                warningElement.style.display = 'none';
            }
        }
        
        // Function to get time allocations from sliders
        function getTimeAllocations() {
            const container = document.getElementById('allocation-sliders');
            const selectedItemsJson = container.dataset.selectedItems;
            
            if (!selectedItemsJson) {
                return [];
            }
            
            const selectedItems = JSON.parse(selectedItemsJson);
            const allocations = [];
            
            selectedItems.forEach(item => {
                allocations.push({
                    id: item.id,
                    type: item.type,
                    minutes: item.allocation
                });
            });
            
            return allocations;
        }
        
        // Modify the savePracticeSession function to include time allocations
        function savePracticeSession(e) {
            e.preventDefault();
            
            const date = document.getElementById('date').value;
            const duration = Number(document.getElementById('duration').value);
            const notes = document.getElementById('notes').value;
            
            // Get selected techniques
            const techniques = [];
            document.querySelectorAll('#technique-checkboxes input:checked').forEach(checkbox => {
                techniques.push(Number(checkbox.getAttribute('data-tech-id')));
            });
            
            // Get selected songs
            const songs = [];
            document.querySelectorAll('#song-checkboxes input:checked').forEach(checkbox => {
                songs.push(Number(checkbox.getAttribute('data-song-id')));
            });
            
            // Get time allocations
            const timeAllocations = getTimeAllocations();
            
            // Create new session
            const newSession = {
                id: Date.now(),
                date,
                duration,
                techniques,
                songs,
                notes,
                timeAllocations // Add this new property
            };
            
            // Add to sessions
            practiceData.sessions.push(newSession);
            
            // Update technique levels - Now using allocated time for each technique
            practiceData.techniques = practiceData.techniques.map(tech => {
                const techAllocation = timeAllocations.find(
                    a => a.type === 'technique' && a.id === tech.id
                );
                
                if (techAllocation) {
                    const levelIncrease = techAllocation.minutes / practiceData.settings.levelUpMinutes;
                    return { 
                        ...tech, 
                        level: Math.min(tech.level + levelIncrease, 10) 
                    };
                }
                return tech;
            });
            
            // Update song progress - Now using allocated time for each song
            practiceData.songs = practiceData.songs.map(song => {
                const songAllocation = timeAllocations.find(
                    a => a.type === 'song' && a.id === song.id
                );
                
                if (songAllocation) {
                    const progressIncrease = (songAllocation.minutes / practiceData.settings.songCompletionMinutes) * 100;
                    return { 
                        ...song, 
                        progress: Math.min(song.progress + progressIncrease, 100) 
                    };
                }
                return song;
            });
            
            // Reset form
            document.getElementById('duration').value = '30';
            document.getElementById('notes').value = '';
            document.querySelectorAll('#technique-checkboxes input').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#song-checkboxes input').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset time allocation sliders
            document.getElementById('allocation-sliders').innerHTML = '';
            document.getElementById('allocation-sliders').dataset.selectedItems = '';
            document.getElementById('total-allocated').textContent = '0';
            document.getElementById('remaining-time').textContent = '30';
            document.getElementById('allocation-warning').style.display = 'none';
            
            saveUserData();
            renderApp();
        }
        
        // Modify the deleteSession function to handle timeAllocations
        function deleteSession(sessionId) {
            const session = practiceData.sessions.find(s => s.id === sessionId);
            
            if (session) {
                // If the session has timeAllocations, use them to reverse progress
                if (session.timeAllocations && session.timeAllocations.length > 0) {
                    // Reverse technique level increases
                    practiceData.techniques = practiceData.techniques.map(tech => {
                        const techAllocation = session.timeAllocations.find(
                            a => a.type === 'technique' && a.id === tech.id
                        );
                        
                        if (techAllocation) {
                            const levelDecrease = techAllocation.minutes / practiceData.settings.levelUpMinutes;
                            return {
                                ...tech,
                                level: Math.max(0, tech.level - levelDecrease)
                            };
                        }
                        return tech;
                    });
                    
                    // Reverse song progress
                    practiceData.songs = practiceData.songs.map(song => {
                        const songAllocation = session.timeAllocations.find(
                            a => a.type === 'song' && a.id === song.id
                        );
                        
                        if (songAllocation) {
                            const progressDecrease = (songAllocation.minutes / practiceData.settings.songCompletionMinutes) * 100;
                            return {
                                ...song,
                                progress: Math.max(0, song.progress - progressDecrease)
                            };
                        }
                        return song;
                    });
                } else {
                    // Fallback to the original method if timeAllocations aren't available
                    // Reverse technique level increases
                    practiceData.techniques = practiceData.techniques.map(tech => {
                        if (session.techniques.includes(tech.id)) {
                            const levelDecrease = session.duration / practiceData.settings.levelUpMinutes;
                            return {
                                ...tech,
                                level: Math.max(0, tech.level - levelDecrease)
                            };
                        }
                        return tech;
                    });
                    
                    // Reverse song progress
                    practiceData.songs = practiceData.songs.map(song => {
                        if (session.songs.includes(song.id)) {
                            const progressDecrease = (session.duration / practiceData.settings.songCompletionMinutes) * 100;
                            return {
                                ...song,
                                progress: Math.max(0, song.progress - progressDecrease)
                            };
                        }
                        return song;
                    });
                }
                
                // Remove session
                practiceData.sessions = practiceData.sessions.filter(s => s.id !== sessionId);
                
                saveUserData();
                renderApp();
            }
        }
        
        // Modify the renderHistory function to show time allocations
        function renderHistory() {
            const historyBody = document.getElementById('history-body');
            historyBody.innerHTML = '';
            
            [...practiceData.sessions].reverse().forEach(session => {
                const row = document.createElement('tr');
                
                // Get technique names with allocations
                let techNames = '';
                if (session.timeAllocations) {
                    const techAllocations = session.timeAllocations.filter(a => a.type === 'technique');
                    techNames = techAllocations.map(alloc => {
                        const tech = practiceData.techniques.find(t => t.id === alloc.id);
                        return tech ? `${tech.name} (${alloc.minutes}m)` : '';
                    }).join(', ');
                } else {
                    techNames = session.techniques.map(techId => {
                        const tech = practiceData.techniques.find(t => t.id === techId);
                        return tech ? tech.name : '';
                    }).join(', ');
                }
                
                // Get song names with allocations
                let songNames = '';
                if (session.timeAllocations) {
                    const songAllocations = session.timeAllocations.filter(a => a.type === 'song');
                    songNames = songAllocations.map(alloc => {
                        const song = practiceData.songs.find(s => s.id === alloc.id);
                        return song ? `${song.name} (${alloc.minutes}m)` : '';
                    }).join(', ');
                } else {
                    songNames = session.songs.map(songId => {
                        const song = practiceData.songs.find(s => s.id === songId);
                        return song ? song.name : '';
                    }).join(', ');
                }
                
                row.innerHTML = `
                    <td>${session.date}</td>
                    <td>${session.duration} minutes</td>
                    <td>${techNames}</td>
                    <td>${songNames}</td>
                    <td>
                        <button class="delete-btn" data-session-id="${session.id}">Delete</button>
                    </td>
                `;
                historyBody.appendChild(row);
            });
            
            // Add delete event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sessionId = Number(this.getAttribute('data-session-id'));
                    deleteSession(sessionId);
                });
            });
        }
        
        // Add event listeners for technique and song checkboxes to update time allocation sliders
        function addCheckboxListeners() {
            // For techniques
            document.querySelectorAll('#technique-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTimeAllocationSliders);
            });
            
            // For songs
            document.querySelectorAll('#song-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTimeAllocationSliders);
            });
            
            // For duration input
            document.getElementById('duration').addEventListener('change', updateTimeAllocationSliders);
        }
        
        // Update the renderTechniqueCheckboxes and renderSongCheckboxes functions to add listeners
        function renderTechniqueCheckboxes() {
            const container = document.getElementById('technique-checkboxes');
            container.innerHTML = '';
            
            practiceData.techniques.forEach(tech => {
                const checkbox = document.createElement('div');
                checkbox.innerHTML = `
                    <label>
                        <input type="checkbox" data-tech-id="${tech.id}"> ${tech.name}
                    </label>
                `;
                container.appendChild(checkbox);
            });
            
            // Add listeners to checkboxes
            document.querySelectorAll('#technique-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTimeAllocationSliders);
            });
        }
        
        function renderSongCheckboxes() {
            const container = document.getElementById('song-checkboxes');
            container.innerHTML = '';
            
            practiceData.songs.forEach(song => {
                const checkbox = document.createElement('div');
                checkbox.innerHTML = `
                    <label>
                        <input type="checkbox" data-song-id="${song.id}"> ${song.name}
                    </label>
                `;
                container.appendChild(checkbox);
            });
            
            // Add listeners to checkboxes
            document.querySelectorAll('#song-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTimeAllocationSliders);
            });
        }
        
        // Document Ready - Make sure to include this in your event listener section
        document.addEventListener('DOMContentLoaded', () => {
            // Your existing DOMContentLoaded code...
            
            // For duration input
            document.getElementById('duration').addEventListener('change', updateTimeAllocationSliders);
        });
    </script>
</body>
</html>
